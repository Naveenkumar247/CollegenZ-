<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Post | Collegenz</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet"/>

<style>

body{
  background:#f5f5f5;
  font-family:Arial, sans-serif;
}

.card{
  max-width:700px;
  margin:30px auto;
  border-radius:18px;
  border:none;
  box-shadow:0 4px 15px rgba(0,0,0,.1);
  padding:20px;
}

.postuser-info{
  display:flex;
  align-items:center;
  gap:12px;
}

.postprofile-pic{
  width:55px;
  height:55px;
  border-radius:50%;
  object-fit:cover;
}

.user-details p{
  margin:0;
  color:gray;
  font-size:.9rem;
}

.carousel img{
  border-radius:12px;
}

.action-bar{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-top:12px;
}

.action-left{
  display:flex;
  gap:25px;
  align-items:center;
}

.action-btn{
  cursor:pointer;
  color:#444;
  display:flex;
  align-items:center;
  gap:6px;
}

.action-btn i{
  font-size:1.5rem;
}

.see-more{
  color:#0d6efd;
  cursor:pointer;
  font-weight:500;
  text-decoration:none;
}

.brand-box{
  margin-top:25px;
  text-align:center;
}

.join-btn{
  background:#228B22;
  color:white;
  border:none;
  padding:10px 25px;
  border-radius:8px;
  font-weight:600;
}

.join-btn:hover{
  background:#1b6f1b;
}

</style>
</head>

<body>

<div class="card text-center" id="postContainer">
<h5>Loading...</h5>
</div>

<script>

/* ================= GET POST ================= */

const postId = window.location.pathname.split("/").pop();

fetch(`/api/post/${postId}`)
.then(res=>res.json())
.then(p=>{

if(p.error){
document.body.innerHTML="<h3>Post not found</h3>";
return;
}

const container = document.getElementById("postContainer");

const images = Array.isArray(p.imageurl)
  ? p.imageurl
  : [p.imageurl];

/* ================= CAROUSEL ================= */

let indicators = "";
images.forEach((_, i) => {
  indicators += `
  <button type="button"
    data-bs-target="#carousel-${p._id}"
    data-bs-slide-to="${i}"
    ${i === 0 ? "class='active'" : ""}>
  </button>`;
});

let slides = "";
images.forEach((img, i) => {
  slides += `
  <div class="carousel-item ${i === 0 ? "active" : ""}">
    <div class="position-relative">

      <img src="${img}"
        class="d-block w-100 img-fluid"
        style="max-height:600px;object-fit:contain;background:#f8f9fa">

      ${
        images.length > 1
          ? `
        <div class="position-absolute top-0 end-0
            bg-dark text-white px-2 py-1 m-2 rounded small opacity-75">
            ${i + 1}/${images.length}
        </div>`
          : ""
      }

    </div>
  </div>`;
});

const carouselHTML = `
<div id="carousel-${p._id}"
     class="carousel slide"
     data-bs-touch="true">

  ${
    images.length > 1
      ? `<div class="carousel-indicators">${indicators}</div>`
      : ""
  }

  <div class="carousel-inner">
    ${slides}
  </div>

</div>
`;



/* ================= DESCRIPTION TYPE ================= */

let caption = "";

/* ---------- GENERAL POST ---------- */
if (p.postType === "general") {

  const short = p.data?.slice(0, 120) || "";
  const rest = p.data?.slice(120) || "";

  caption = `
  <p id="caption-${p._id}">
    ${short}
    ${
      rest
        ? `
        <span id="dots-${p._id}">...</span>
        <span id="more-${p._id}" style="display:none;">${rest}</span>
        <a class="see-more" onclick="expandText('${p._id}')"> more</a>
        `
        : ""
    }
  </p>`;
}


/* ---------- EVENT POST ---------- */
else if (p.postType === "event") {

  caption = `
  <div class="details-box">

    <div class="row-${p._id}"
         style="font-weight:600;text-align:center">
      ${p.data || "-"}
    </div>

    <table class="table details-table row-${p._id}" style="display:none">
      <tbody>

        <tr><th>Date</th><td>${p.event_date || "-"}</td></tr>
        <tr><th>Time</th><td>${p.event_time || "-"}</td></tr>
        <tr><th>Mode</th><td>${p.event_mode || "-"}</td></tr>
        <tr><th>Location</th><td>${p.event_location || "-"}</td></tr>
        <tr><th>Contact</th><td>${p.event_contact || "-"}</td></tr>

        <tr>
          <th>Description</th>
          <td>${p.event_description || "-"}</td>
        </tr>

        <tr>
          <th>Register</th>
          <td>
            <a href="${
              p.event_link?.startsWith("http")
                ? p.event_link
                : "https://" + p.event_link
            }" target="_blank">
              Open Link
            </a>
          </td>
        </tr>

      </tbody>
    </table>

    <a class="see-more"
       onclick="toggleDetails('${p._id}')">
       View details
    </a>

  </div>`;
}


/* ---------- HIRING POST ---------- */
else {

  caption = `
  <div class="details-box">

    <div class="row-${p._id}"
         style="font-weight:600;text-align:center">
      ${p.data || "-"}
    </div>

    <table class="table details-table row-${p._id}" style="display:none">
      <tbody>

        <tr><th>Location</th><td>${p.job_location || "-"}</td></tr>
        <tr><th>Mode</th><td>${p.job_mode || "-"}</td></tr>
        <tr><th>Contact</th><td>${p.job_contact || "-"}</td></tr>

        <tr>
          <th>Description</th>
          <td>${p.job_description || "-"}</td>
        </tr>

        <tr><th>Deadline</th><td>${p.job_deadline || "-"}</td></tr>

        <tr>
          <th>Apply</th>
          <td>
            <a href="${
              p.job_link?.startsWith("http")
                ? p.job_link
                : "https://" + p.job_link
            }" target="_blank">
              Apply
            </a>
          </td>
        </tr>

      </tbody>
    </table>

    <a class="see-more"
       onclick="toggleDetails('${p._id}')">
       View details
    </a>

  </div>`;
}



/* ================= UI BUILD ================= */

container.innerHTML = `

<div class="postuser-info">
  <img src="${p.picture || "/uploads/profilepic.jpg"}"
       class="postprofile-pic">

  <div class="user-details text-start">
    <strong>${p.username || p.userEmail}</strong>
    <p>${p.college || ""}</p>
  </div>
</div>

<div class="my-3">
  ${carouselHTML}
</div>

${caption}

<div class="brand-box">

  <h3>CollegenZ</h3>

  <p style="color:#666;font-size:.9rem;">
    For more information visit <strong>CollegenZ</strong>
  </p>

  <a href="https://collegenz.in" class="join-btn">
    Join Now
  </a>

</div>
`;

});

/* ================= SEE MORE ================= */

function expandText(id){
document.getElementById("dots-"+id).style.display="none";
document.getElementById("more-"+id).style.display="inline";
}

/* ================= SHARE ================= */

function expandText(id){
  document.getElementById("dots-"+id).style.display="none";
  document.getElementById("more-"+id).style.display="inline";
}

function toggleDetails(id){
  document.querySelectorAll(".row-"+id).forEach(r=>{
    r.style.display="table-row";
  });

  const btn=document.querySelector(`[onclick="toggleDetails('${id}')"]`);
  if(btn) btn.remove();
}

function sharePost(id){

const url=`https://collegenz.in/share/${id}`;

if(navigator.share){
navigator.share({
title:"CollegenZ Post",
text:"Check out this post on Collegenz ðŸŒ±",
url:url
});
}else{
window.open(
`https://wa.me/?text=${encodeURIComponent(url)}`,
"_blank"
);
}
}

</script>

</body>
</html>
